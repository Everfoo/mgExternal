/**
 * mgExternal 1.0.22
 *
 * Copyright 2012 Ricard Osorio Ma√±anas
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */
(function(d,t){d.fn.mgExternal=function(a,c){return this.each(function(){d(this).data("mgExternal",mgExternal(this,a,c))})};window.mgExternal=function(a,c,b){if(!(this instanceof mgExternal))return new mgExternal(a,c,b);if(!a||a.tagName===t)b=c,c=a,a=null;"object"==typeof c&&(b=c,c=null);this.settings={display:"modal",auto:!a,renew:b&&b.tooltip&&"hover"==b.tooltip.bind?!1:!0,autoFocus:!0,outsideClose:!0,escClose:!0,destroyOnClose:!a,css:{},extraClass:b&&b.display?"inline"!=b.display?"mgE-"+b.display:null:"mgE-modal",activeClass:"active",showDelay:b&&"tooltip"==b.display&&b.tooltip&&"hover"==b.tooltip.bind?200:0,hideDelay:b&&"tooltip"==b.display&&b.tooltip&&"hover"==b.tooltip.bind?200:0,showSpeed:300,hideSpeed:300,overlayShow:!b||!b.display||"modal"==b.display?!0:!1,overlayColor:"#fff",overlayOpacity:0.7,overlayShowSpeed:300,overlayHideSpeed:300,submitIdentifier:'input[type="submit"]',focusPriority:[":not(:radio):input:visible:enabled:first"],zIndexContainer:999,zIndexTooltipTrigger:998,zIndexOverlay:997,breatheSeparation:b&&"tooltip"==b.display?15:40,ajaxUrl:null,ajaxData:{},modal:{animateSpeed:500},tooltip:{bind:"click",position:"top center",positionSource:d(a),distance:0,arrowSize:8,arrowDistance:15,arrowFrontColor:null,arrowBorderColor:null},onCreateElements:function(){},onBeforeShow:function(){},onShow:function(){},onBeforeClose:function(){},onClose:function(){},onDestroy:function(){},onContentReady:function(){},onJsonData:function(){}};d.extend(!0,this.settings,this.defaults,b,d(a).data("mgExternal"));this.$trigger=d(a);this.$container=null;this.$content=b&&"inline"==b.display?this.$trigger:null;this.$tooltipArrow=null;this._defaultContent=c;this._defaultAjaxUrl=this.settings.ajaxUrl;this._lastSubmitName=null;this._show=!1;this._triggerZIndexBackup=null;if(this.$trigger){var e=this;switch(this.settings.display){case "modal":this.$trigger.bind("click",function(a){e.open(e.settings.showDelay);a.preventDefault();a.stopPropagation()});break;case "tooltip":switch(this.settings.tooltip.bind){case "click":this.$trigger.bind("click",function(a){e.isVisible()?e.close():e.open(e.settings.showDelay);a.preventDefault();a.stopPropagation()});break;case "hover":this.$trigger.bind({mouseenter:function(){e.open(e.settings.showDelay)},mouseleave:function(){e.close(e.settings.hideDelay)},mouseup:function(a){a.stopPropagation()}});break;case "focus":this.$trigger.bind({focus:function(){e.open(e.settings.showDelay)},blur:function(){e.close(e.settings.hideDelay)},mouseup:function(a){a.stopPropagation()}})}break;case "inline":this.bindSpecialActions()}}this.settings.auto&&this.open()};mgExternal.prototype={defaults:{},isVisible:function(){return"inline"==this.settings.display?!0:this.$container&&this.$container.is(":visible")&&"hidden"!=this.$container.css("visibility")},open:function(a){var c=this;this._show=!0;a?setTimeout(function(){c._open()},a):this._open()},_open:function(){if(this._show){var a=this;this.$trigger.addClass(this.settings.activeClass);if(this.settings.renew||!this.$container){this.settings.ajaxUrl=this._defaultAjaxUrl;this._lastSubmitName=null;var c=this.settings.ajaxUrl||this.$trigger.attr("href");this._defaultContent?this.setContent(this._defaultContent):c.match(/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i)?(this.setContent('<img src="'+c+'" style="display:block;" />'),setTimeout(function(){a.moveContainer()},1E3)):this.loadAjaxContent()}else this.showContainer()}},close:function(a){var c=this;this._show=!1;a?setTimeout(function(){c._close()},a):this._close()},_close:function(){if(!this._show&&!("inline"==this.settings.display||!this.isVisible()||!1===this.settings.onBeforeClose.call(this))){var a=this;this.$trigger.removeClass(this.settings.activeClass);this.$container.fadeOut(this.settings.hideSpeed,function(){a.settings.destroyOnClose&&a.destroy();"modal"==a.settings.display&&a.settings.overlayShow?d("#mgExternal-overlay").fadeOut(a.settings.overlayHideSpeed,function(){a.$container.parent().hide();d("html,body").css("overflow","");d("body").css("margin-right","");a.settings.onClose.call(a)}):a.settings.onClose.call(a)});"tooltip"==this.settings.display&&this.settings.overlayShow&&d("#mgExternal-overlay").fadeOut(this.settings.overlayHideSpeed,function(){a.$trigger.css({position:a._triggerZIndexBackup.position,zIndex:a._triggerZIndexBackup.zIndex})})}},setContent:function(a){!this.$container&&"inline"!=this.settings.display&&this.createElements();this.$content.html(a).children().css({marginLeft:0,marginRight:0}).first().css("margin-top","0").end().last().css("margin-bottom","0");this.isVisible()||("modal"==this.settings.display&&this.settings.overlayShow&&this.$container.parent().css("visibility","hidden").show(),this.$container.css("visibility","hidden").show());this.bindSpecialActions();this.setFocus();this.settings.onContentReady.call(this);"inline"!=this.settings.display&&(this.isVisible()?this.moveContainer():("modal"==this.settings.display&&this.settings.overlayShow&&this.$container.parent().hide().css("visibility","visible"),this.$container.hide().css("visibility","visible"),this.showContainer()))},showContainer:function(){if(!1!==this.settings.onBeforeShow.call(this)){var a=this;if("tooltip"==this.settings.display&&this.settings.overlayShow)this._triggerZIndexBackup={position:"static"==this.$trigger.css("position")?"":this.$trigger.css("position"),zIndex:0==this.$trigger.css("z-index")?"":this.$trigger.css("z-index")},this.$trigger.css({position:this._triggerZIndexBackup.position?null:"relative",zIndex:this.settings.zIndexTooltipTrigger});var c=function(){"modal"==a.settings.display&&a.settings.overlayShow&&a.$container.parent().show();a.moveContainer(!0,!0);a.$container.find("img").bind("load",function(){a.moveContainer(!0)});a.$container.fadeIn(a.settings.showSpeed,function(){a.setFocus();a.settings.onShow.call(a)})};if(this.settings.overlayShow){var b=d("#mgExternal-overlay");b.css({background:this.settings.overlayColor,opacity:this.settings.overlayOpacity});"modal"==this.settings.display?(d("html,body").css("overflow","hidden"),d("body").css("margin-right",this._browserScrollbarWidth),b.fadeIn(this.settings.overlayShowSpeed,c)):(b.fadeIn(this.settings.overlayShowSpeed),c())}else c()}},destroy:function(){"modal"==this.settings.display&&this.settings.overlayShow?this.$container.parent().remove():this.$container.remove();this.settings.onDestroy.call(this)},bindSpecialActions:function(){var a=this;this.$content.find("form").bind("submit",function(b){a.loadAjaxContent(d(this));b.preventDefault()});this.$content.find(".mgExternal-redirect").bind("click",function(b){a.settings.ajaxUrl=d(this).attr("href");a.loadAjaxContent();b.preventDefault()});this.$content.find(".mgExternal-close").bind("click",function(b){a.close();b.preventDefault()});var c=this.$content.find(".mgExternal-onLoad").data("mgExternal-onLoad");c&&c.call(this)},loadAjaxContent:function(a){var c=this,b=d.extend({},c.settings.ajaxData);if(a)this._lastSubmitName=a.find(this.settings.submitIdentifier).val(),a.find(":input").each(function(){d(this).is(":checkbox")?b[d(this).attr("name")]=d(this).prop("checked")?1:0:d(this).is(":radio")?d(this).prop("checked")&&(b[d(this).attr("name")]=d(this).val()):b[d(this).attr("name")]=d(this).val()});if(a&&"multipart/form-data"==a.attr("enctype")){var e="mgExternal-iframe"+Math.floor(99999*Math.random());d('<iframe name="'+e+'" id="'+e+'" src="" style="display:none;"></iframe>').appendTo("body").bind("load",function(){var a=d(this).contents().find("body").html();try{var b=eval("("+a+")");if("object"==typeof b){c.settings.onJsonData.call(c,b);return}}catch(e){}c.setContent(a)});a.clone().insertAfter(a);d.each(this.settings.ajaxData,function(b,c){a.append('<input type="hidden" name="'+b+'" value="'+c+'" />')});a.appendTo(d("#"+e)).attr("action",this.settings.ajaxUrl||this.$trigger.attr("href")).attr("target",e).append('<input type="hidden" name="is_iframe" value="true" />').unbind("submit").trigger("submit")}else d.ajax({url:this.settings.ajaxUrl||this.$trigger.attr("href"),type:a?"POST":"GET",data:b,success:function(a){"object"==typeof a?c.settings.onJsonData.call(c,a):c.setContent(a)},error:function(){c.setContent('<div class="notice alert">S\'ha produ\u00eft un error</div>')}});this.$content&&this.$content.find(":input").prop("disabled",!0).addClass("disabled")},setFocus:function(){if(this.settings.autoFocus){var a=this.$content.find(this.settings.submitIdentifier+'[value="'+this._lastSubmitName+'"]').parents("form:visible");0==a.length&&(a=this.$content.find("form:first:visible"));if(0==a.length)a=this.$content;for(var c=0,b=a.find(this.settings.focusPriority[c]);0==b.length&&c<=this.settings.focusPriority.length;b=a.find(this.settings.focusPriority[++c]));setTimeout(function(){b.trigger("focus")},10)}},createElements:function(){var a=this;if(!this.$container)this.$container=d("<div/>").addClass("mgExternal-container").addClass(this.settings.extraClass).css({position:"absolute",zIndex:this.settings.zIndexContainer}).hide().appendTo("modal"==this.settings.display&&this.settings.overlayShow?d("<div/>").css({height:"100%",left:0,overflowY:"scroll",position:"fixed",top:0,width:"100%",zIndex:this.settings.zIndexContainer}).appendTo("body"):"body").bind("mouseup",function(a){a.stopPropagation()}),this.$content=d("<div/>").addClass("mgExternal-content").css(this.settings.css).appendTo(this.$container),"hover"==this.settings.tooltip.bind&&(this.$container.bind("mouseenter",function(){a.open(a.settings.showDelay)}),this.$container.bind("mouseleave",function(){a.close(a.settings.hideDelay)})),d(window).bind("resize",function(){a.moveContainer()}),"tooltip"==this.settings.display&&d(window).bind("scroll",function(){a.moveContainer()}),this.settings.outsideClose&&d("body").bind("mouseup",function(c){1==c.which&&(!c.originalEvent.originalTarget||!(c.originalEvent.originalTarget instanceof XULElement))&&a.close()}),this.settings.escClose&&d(document).bind("keyup",function(c){27==c.keyCode&&a.close()}),a.settings.onCreateElements.call(a);this.settings.overlayShow&&0==d("#mgExternal-overlay").length&&d("<div/>").attr("id","mgExternal-overlay").css({height:"100%",left:0,position:"fixed",top:0,width:"100%",zIndex:this.settings.zIndexOverlay}).hide().appendTo("body");if(!this.$tooltipArrow&&"tooltip"==this.settings.display&&this.settings.tooltip.arrowSize)this.$tooltipArrow=d("<div/>").addClass("mgExternal-arrow").css({position:"absolute"}).appendTo(this.$container).append(d("<div/>").addClass("mgExternal-arrow-shadow").css({borderColor:this.settings.tooltip.arrowBorderColor,borderStyle:"solid",borderWidth:this.settings.tooltip.arrowSize})).append(d("<div/>").addClass("mgExternal-arrow-front").css({borderColor:this.settings.tooltip.arrowFrontColor||this.$content.css("backgroundColor"),borderStyle:"solid",position:"absolute",borderWidth:this.settings.tooltip.arrowSize}))},moveContainer:function(a,c){if(a||this.isVisible())switch(this.settings.display){case "modal":this.moveModal(c);break;case "tooltip":this.moveTooltip()}},moveModal:function(a){var c=0,b=0;this.$container.css("padding",this.settings.breatheSeparation);var b=this.$container.outerHeight(!0),e=this.$container.outerWidth(!0);this.settings.overlayShow&&(e+=this._browserScrollbarWidth);b<d(window).height()&&(c=d(document).scrollTop()+(d(window).height()-b)/2);c<d(document).scrollTop()&&(c=d(document).scrollTop());b=(d(window).width()-e)/2;0>b&&(b=0);0<this.settings.modal.animateSpeed&&!a?this.$container.stop().animate({top:c,left:b,opacity:1},this.settings.modal.animateSpeed):this.$container.css({top:c,left:b,opacity:1})},moveTooltip:function(){var a,c,b,e,m,k,f=this.$container.clone();f.css({left:0,top:0,position:"absolute",visibility:"hidden"}).children().css({height:"",width:""}).end().show().appendTo("body");this.$content.css("height",this.settings.css.height||"").css("height",f.children().height()).css("width",this.settings.css.width||"").css("width",f.children().width());f.remove();var f={top:0,left:0},r=this.settings.breatheSeparation,j=d(window).height(),w=d(window).width(),n=this.$container.outerHeight(!0),o=this.$container.outerWidth(!0),i=this.settings.tooltip.positionSource.offset(),p=this.settings.tooltip.positionSource.outerHeight(),q=this.settings.tooltip.positionSource.outerWidth(),s=this.settings.tooltip.distance,g=this.settings.tooltip.arrowSize,l=this.settings.tooltip.arrowDistance,u=d(document).scrollTop(),v=d(document).scrollLeft(),h=this.settings.tooltip.position.split(" ")[0],t=this.settings.tooltip.position.split(" ")[1];"bottom"==h&&j<i.top-u+p+n+r&&(h="top");"top"==h&&i.top-u-r<n&&(h="bottom");"right"==h&&w<i.left-v+q+o+r&&(h="left");"left"==h&&i.left-v-r<o&&(h="right");switch(h){case "top":f.top=i.top-n-s-g;break;case "bottom":f.top=i.top+p+s+g;break;case "left":f.left=i.left-o-s-g;break;case "right":f.left=i.left+q+s+g}switch(t){case "top":f.top=i.top;break;case "middle":f.top=i.top-n/2+p/2;break;case "bottom":f.top=i.top-n+p;break;case "left":f.left=i.left;break;case "center":f.left=i.left-o/2+q/2;break;case "right":f.left=i.left-o+q}for("left"==h||"right"==h?(a="top",c=p,b=i.top,e=n,m=j,k=u):(a="left",c=q,b=i.left,e=o,m=w,k=v);f[a]-k+e+r>m;)if(j=!1,e>=c?f[a]+e>b+c&&(j=!0):f[a]>b&&(j=!0),j)f[a]--;else break;for(;f[a]-k<r;)if(j=!1,e>=c?f[a]<b&&(j=!0):f[a]+e<b+c&&(j=!0),j)f[a]++;else break;if(g&&c<g+2*l&&(m=b+c/2-g-f[a],k=f[a]+e-b-c/2-g,!(m<l&&k<l)&&(m<l&&(f[a]=b+c/2-g-l),k<l&&(f[a]=b-e+c/2+g+l),m=b+c/2-g-f[a],k=f[a]+e-b-c/2-g,m<l||k<l)))f[a]=b-(e-2*g)/2;g?(this.$tooltipArrow||this.createElements(),this.$tooltipArrow.show(),"top"==h||"bottom"==h?this.$tooltipArrow.css({height:g,left:o<q?o/2-g:i.left-f.left+q/2-g,top:"top"==h?"":-g,width:2*g}).find("div").css({borderLeftColor:"transparent",borderRightColor:"transparent",borderBottomWidth:"top"==h?0:g,borderTopWidth:"bottom"==h?0:g}).filter(".mgExternal-arrow-front").css({left:0,top:("top"==h?"-":"")+this.$content.css("borderBottomWidth")}):this.$tooltipArrow.css({height:2*g,left:"left"==h?"":-g,right:"right"==h?"":-g,top:n<p?n/2-g:i.top-f.top+p/2-g,width:g}).find("div").css({borderBottomColor:"transparent",borderTopColor:"transparent",borderLeftWidth:"right"==h?0:g,borderRightWidth:"left"==h?0:g}).filter(".mgExternal-arrow-front").css({left:("left"==h?"-":"")+this.$content.css("borderBottomWidth"),top:0})):this.$tooltipArrow&&this.$tooltipArrow.hide();this.$container.css(f)}};d(function(){var a=d("<div/>").css({height:100,overflow:"hidden",position:"absolute",width:100}).append(d("<div/>").css("height","100%")).appendTo("body");window.mgExternal.prototype._browserScrollbarWidth=a.find("> div").width()-a.css("overflow-y","scroll").find("> div").width();a.remove()})})(jQuery,window);