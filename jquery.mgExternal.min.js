/**
 * mgExternal 1.0.13
 * www.magicalglobe.com/projects/mgExternal
 *
 * Copyright 2011 Ricard Osorio Mañanas
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */
(function($){$.fn.mgExternal=function(a,b){return this.each(function(){$(this).data('mgExternal',mgExternal(this,a,b))})};window.mgExternal=function(b,c,d){if(!(this instanceof mgExternal))return new mgExternal(b,c,d);if(b.tagName==undefined){d=c;c=b;b=null}if(typeof c=='object'){d=c;c=null}this.settings={display:'modal',content:(d&&d.display=='inline')?$(b):$('<div/>'),auto:!b,renew:(d&&d.tooltip&&d.tooltip.bind=='hover')?false:true,autoFocus:true,outsideClose:true,escClose:true,destroyOnClose:!b,dataCss:{},extraClass:(d&&d.display)?(d.display!='inline'?d.display:null):'modal',showDelay:(d&&d.display=='tooltip'&&d.tooltip&&d.tooltip.bind=='hover')?200:0,hideDelay:(d&&d.display=='tooltip'&&d.tooltip&&d.tooltip.bind=='hover')?200:0,showSpeed:300,hideSpeed:300,overlayColor:'#fff',overlayOpacity:(!d||!d.display||d.display=='modal')?0.7:0,submitIdentifier:'input[type="submit"]',focusPriority:[':not(:radio):input:visible:enabled:first'],ajaxUrl:null,ajaxData:{},tooltip:{bind:'click',position:'top center',positionFrom:(d&&d.tooltip&&d.tooltip.arrowSize==0)?'limit':'center',positionSource:$(b),distance:0,arrowSize:9,arrowDistance:15,arrowFrontColor:null,arrowBorderColor:null,activeClass:'active'},onCreateElements:function(){},onBeforeShow:function(){},onShow:function(){},onBeforeClose:function(){},onClose:function(){},onDestroy:function(){},onContentReady:function(){},onJsonData:function(a){}};$.extend(true,this.settings,this.defaults,d,$(b).data('mgExternal'));this.$trigger=$(b);this.$container=null;this.$data=null;this.$content=this.settings.content;this.$tooltipArrow=null;this._defaultContent=c;this._defaultAjaxUrl=this.settings.ajaxUrl;this._lastSubmitName=null;this._show=false;this._triggerZIndexBackup=null;if(this.$trigger){var f=this;switch(this.settings.display){case'modal':this.$trigger.bind('click',function(e){f.open(f.settings.showDelay);e.preventDefault();e.stopPropagation()});break;case'tooltip':switch(this.settings.tooltip.bind){case'click':this.$trigger.bind('click',function(e){f.isVisible()?f.close():f.open(f.settings.showDelay);e.preventDefault();e.stopPropagation()});break;case'hover':this.$trigger.bind({mouseenter:function(){f.open(f.settings.showDelay)},mouseleave:function(){f.close(f.settings.hideDelay)},mouseup:function(e){e.stopPropagation()}});break;case'focus':this.$trigger.bind({focus:function(){f.open(f.settings.showDelay)},blur:function(){f.close(f.settings.hideDelay)},mouseup:function(e){e.stopPropagation()}});break}break;case'inline':this.bindSpecialActions();break}}if(this.settings.auto)this.open()};mgExternal.prototype={defaults:{},isVisible:function(){if(this.settings.display=='inline'){return true}else{return this.$container&&this.$container.is(':visible')&&this.$container.css('visibility')!='hidden'}},open:function(a){var b=this;this._show=true;setTimeout(function(){b.realOpen()},a||10)},realOpen:function(){if(!this._show)return;if(this.settings.renew||!this.$container){this.settings.ajaxUrl=this._defaultAjaxUrl;this._lastSubmitName=null;if(this._defaultContent){this.setContent(this._defaultContent)}else{this.loadAjaxContent()}}else{this.showContainer()}},close:function(a){var b=this;this._show=false;setTimeout(function(){b.realClose()},a||10)},realClose:function(){if(this._show||!this.isVisible()||this.settings.onBeforeClose.call(this)===false||this.settings.display=='inline')return;var a=this;if(this.settings.display=='tooltip'){this.$trigger.removeClass(this.settings.tooltip.activeClass).css({position:this._triggerZIndexBackup.position,zIndex:this._triggerZIndexBackup.zIndex})}this.$container.fadeOut(this.settings.hideSpeed,function(){if(a.settings.destroyOnClose)a.destroy();if(a.settings.overlayOpacity>0&&a.settings.display=='modal'){$('#mgExternal-overlay').fadeOut(a.settings.hideSpeed,function(){a.settings.onClose.call(a)})}else{a.settings.onClose.call(a)}});if(this.settings.overlayOpacity>0&&this.settings.display!='modal')$('#mgExternal-overlay').fadeOut(this.settings.hideSpeed)},setContent:function(a){var b=this;if(!this.$container&&this.settings.display!='inline')this.createElements();this.$content.html(a).children().css({marginLeft:0,marginRight:0}).first().css('margin-top','0').end().last().css('margin-bottom','0');if(!this.isVisible())this.$container.css('visibility','hidden').show();this.bindSpecialActions();this.settings.onContentReady.call(this);this.setFocus();if(this.settings.display!='inline'){if(this.isVisible()){this.moveContainer()}else{this.$container.hide().css('visibility','visible');this.showContainer()}}},showContainer:function(){if(this.settings.onBeforeShow.call(this)===false)return;var a=this;if(this.settings.display=='tooltip'){this._triggerZIndexBackup={position:this.$trigger.css('position'),zIndex:this.$trigger.css('z-index')};this.$trigger.addClass(this.settings.tooltip.activeClass).css({position:this._triggerZIndexBackup.position=='static'?'relative':null,zIndex:998})}var b=function(){a.$container.fadeIn(a.settings.showSpeed,function(){a.settings.onShow.call(a);a.setFocus()})};if(this.settings.overlayOpacity>0){var c=$('#mgExternal-overlay');c.css({background:this.settings.overlayColor,opacity:this.settings.overlayOpacity});if(this.settings.display=='modal'){c.fadeIn(this.settings.showSpeed,b)}else{c.fadeIn(this.settings.showSpeed);b()}}else{b()}this.moveContainer(true);this.$container.find('img').bind('load',function(){a.moveContainer(true)})},destroy:function(){this.$container.remove();this.settings.onDestroy.call(this)},bindSpecialActions:function(){var a=this;this.$content.find('form').bind('submit',function(e){a.loadAjaxContent($(this));e.preventDefault()});this.$content.find('.mgExternal-redirect').bind('click',function(e){a.settings.ajaxUrl=$(this).attr('href');a.loadAjaxContent();e.preventDefault()});this.$content.find('.mgExternal-close').bind('click',function(e){a.close();e.preventDefault()})},loadAjaxContent:function(d){var e=this,ajaxData=$.extend({},e.settings.ajaxData);if(d){this._lastSubmitName=d.find(this.settings.submitIdentifier).val();d.find(':input').each(function(){if($(this).is(':checkbox')){ajaxData[$(this).attr('name')]=$(this).prop('checked')?1:0}else if($(this).is(':radio')){if($(this).prop('checked'))ajaxData[$(this).attr('name')]=$(this).val()}else{ajaxData[$(this).attr('name')]=$(this).val()}})}if(d&&d.attr('enctype')=='multipart/form-data'){alert("multipart form")}else{$.ajax({url:this.settings.ajaxUrl||this.$trigger.attr('href'),type:d?'POST':'GET',data:ajaxData,success:function(a){if(typeof a=='object'){e.settings.onJsonData.call(e,a)}else{e.setContent(a)}},error:function(a,b,c){e.setContent("<div class=\"notice alert\">S'ha produït un error</div>")}})}this.$content.find(':input').prop('disabled',true).addClass('disabled')},setFocus:function(){if(!this.settings.autoFocus)return;var a=this.$content.find(this.settings.submitIdentifier+'[value="'+this._lastSubmitName+'"]').parents('form:visible');if(a.length==0)a=this.$content.find('form:first:visible');if(a.length==0)a=this.$content;for(var i=0,firstInput=a.find(this.settings.focusPriority[i]);firstInput.length==0&&i<=this.settings.focusPriority.length;firstInput=a.find(this.settings.focusPriority[++i]));setTimeout(function(){firstInput.trigger('focus')},10)},createElements:function(){var a=this;if(!this.$container){this.$container=$('<div/>').addClass('mgExternal-container').addClass(this.settings.extraClass).css({position:'absolute',zIndex:999}).hide().appendTo('body').bind('mouseup',function(e){e.stopPropagation()});this.$data=$('<div/>').addClass('mgExternal-data').css(this.settings.dataCss).appendTo(this.$container).append(this.$content);if(this.settings.tooltip.bind=='hover'){this.$container.bind('mouseenter',function(){a.open(a.settings.showDelay)});this.$container.bind('mouseleave',function(){a.close(a.settings.hideDelay)})}$(window).bind('resize',function(){a.moveContainer()});if(this.settings.display=='tooltip')$(window).bind('scroll',function(){a.moveContainer()});if(this.settings.outsideClose){$('body').bind('mouseup',function(e){if(e.which==1)a.close()})}if(this.settings.escClose){$(document).bind('keyup',function(e){if(e.keyCode==27)a.close()})}a.settings.onCreateElements.call(a)}if(this.settings.overlayOpacity>0&&$('#mgExternal-overlay').length==0){this.$modalOverlay=$('<div/>').attr('id','mgExternal-overlay').css({height:$(document).height(),left:0,position:'absolute',top:0,width:$(document).width(),zIndex:997}).hide().appendTo('body')}if(!this.$tooltipArrow&&this.settings.display=='tooltip'&&this.settings.tooltip.arrowSize){this.$tooltipArrow=$('<div/>').addClass('mgExternal-arrow').css({position:'absolute'}).appendTo(this.$container).append($('<div/>').addClass('mgExternal-arrow-shadow').css({borderColor:this.settings.tooltip.arrowBorderColor,borderStyle:'solid',borderWidth:this.settings.tooltip.arrowSize})).append($('<div/>').addClass('mgExternal-arrow-front').css({borderColor:this.settings.tooltip.arrowFrontColor||this.$data.css('backgroundColor'),borderStyle:'solid',position:'absolute',borderWidth:this.settings.tooltip.arrowSize}))}},moveContainer:function(a){if(!a&&!this.isVisible())return;switch(this.settings.display){case'modal':this.moveModal();break;case'tooltip':this.moveTooltip();break}},moveModal:function(){var a=0,left=0,containerHeight=this.$container.outerHeight(true),containerWidth=this.$container.outerWidth(true);if(containerHeight<$(window).height())a=$(document).scrollTop()+(($(window).height()-containerHeight)/2)-15;if(a<($(document).scrollTop()+15))a=$(document).scrollTop()+15;left=($(window).width()-containerWidth)/2;if(left<15)left=15;this.$container.css({top:a,left:left})},moveTooltip:function(){this.$container.css({top:0,left:0});this.$data.css('height','auto').css('height',this.$data.height()).css('width','auto').css('width',this.$data.width());var a={top:0,left:0},breatheSeparation=15,windowHeight=$(window).height(),windowWidth=$(window).width(),containerHeight=this.$container.outerHeight(true),containerWidth=this.$container.outerWidth(true),sourceOffset=this.settings.tooltip.positionSource.offset(),sourceHeight=this.settings.tooltip.positionSource.outerHeight(),sourceWidth=this.settings.tooltip.positionSource.outerWidth(),distance=this.settings.tooltip.distance,arrowSize=this.settings.tooltip.arrowSize,arrowDistance=this.settings.tooltip.arrowDistance,scrollTop=$(document).scrollTop(),scrollLeft=$(document).scrollLeft(),position=this.settings.tooltip.position.split(' ')[0],modifier=this.settings.tooltip.position.split(' ')[1];if(position=='bottom'&&windowHeight<(sourceOffset.top-scrollTop+sourceHeight+containerHeight+breatheSeparation))position='top';if(position=='top'&&(sourceOffset.top-scrollTop-breatheSeparation)<containerHeight)position='bottom';if(position=='right'&&windowWidth<(sourceOffset.left-scrollLeft+sourceWidth+containerWidth+breatheSeparation))position='left';if(position=='left'&&(sourceOffset.left-scrollLeft-breatheSeparation)<containerWidth)position='right';switch(position){case'top':a.top=sourceOffset.top-containerHeight-distance-arrowSize;break;case'bottom':a.top=sourceOffset.top+sourceHeight+distance+arrowSize;break;case'left':a.left=sourceOffset.left-containerWidth-distance-arrowSize;break;case'right':a.left=sourceOffset.left+sourceWidth+distance+arrowSize;break}switch(modifier){case'top':a.top=sourceOffset.top;break;case'middle':a.top=sourceOffset.top-(containerHeight/2)+(sourceHeight/2);break;case'bottom':a.top=sourceOffset.top-containerHeight+sourceHeight;break;case'left':a.left=sourceOffset.left;break;case'center':a.left=sourceOffset.left-(containerWidth/2)+(sourceWidth/2);break;case'right':a.left=sourceOffset.left-containerWidth+sourceWidth;break}var b,posFit;if(position=='left'||position=='right'){posFit={pos:'top',source:sourceHeight,sourceOffset:sourceOffset.top,container:containerHeight,window:windowHeight,scroll:scrollTop}}else{posFit={pos:'left',source:sourceWidth,sourceOffset:sourceOffset.left,container:containerWidth,window:windowWidth,scroll:scrollLeft}}while((a[posFit.pos]-posFit.scroll+posFit.container+breatheSeparation)>posFit.window){b=false;if(posFit.container>=posFit.source){if((a[posFit.pos]+posFit.container)>(posFit.sourceOffset+posFit.source))b=true}else{if(a[posFit.pos]>posFit.sourceOffset)b=true}if(b)a[posFit.pos]--;else break}while((a[posFit.pos]-posFit.scroll)<breatheSeparation){b=false;if(posFit.container>=posFit.source){if(a[posFit.pos]<posFit.sourceOffset)b=true}else{if((a[posFit.pos]+posFit.container)<(posFit.sourceOffset+posFit.source))b=true}if(b)a[posFit.pos]++;else break}if(arrowSize&&posFit.source<(arrowSize+arrowDistance*2)){var c=posFit.sourceOffset+(posFit.source/2)-arrowSize-a[posFit.pos],arrowSeparationBottom=a[posFit.pos]+posFit.container-posFit.sourceOffset-(posFit.source/2)-arrowSize;if(!(c<arrowDistance&&arrowSeparationBottom<arrowDistance)){if(c<arrowDistance){a[posFit.pos]=posFit.sourceOffset+(posFit.source/2)-arrowSize-arrowDistance}if(arrowSeparationBottom<arrowDistance){a[posFit.pos]=posFit.sourceOffset-posFit.container+(posFit.source/2)+arrowSize+arrowDistance;c=posFit.sourceOffset+(posFit.source/2)-arrowSize-a[posFit.pos]}c=posFit.sourceOffset+(posFit.source/2)-arrowSize-a[posFit.pos];arrowSeparationBottom=a[posFit.pos]+posFit.container-posFit.sourceOffset-(posFit.source/2)-arrowSize;if(c<arrowDistance||arrowSeparationBottom<arrowDistance)a[posFit.pos]=posFit.sourceOffset-((posFit.container-(arrowSize*2))/2)}}if(arrowSize){if(!this.$tooltipArrow)this.createElements();this.$tooltipArrow.show();if(position=='top'||position=='bottom'){this.$tooltipArrow.css({height:arrowSize,left:(containerWidth<sourceWidth)?(containerWidth/2)-arrowSize:(sourceOffset.left-a.left)+(sourceWidth/2)-arrowSize,top:position=='top'?'auto':-arrowSize,width:arrowSize*2}).find('div').css({borderLeftColor:'transparent',borderRightColor:'transparent',borderBottomWidth:position=='top'?0:arrowSize,borderTopWidth:position=='bottom'?0:arrowSize}).filter('.mgExternal-arrow-front').css({left:0,top:(position=='top'?'-':'')+this.$data.css('borderBottomWidth')})}else{this.$tooltipArrow.css({height:arrowSize*2,left:position=='left'?'auto':-arrowSize,right:position=='right'?'auto':-arrowSize,top:(containerHeight<sourceHeight)?(containerHeight/2)-arrowSize:(sourceOffset.top-a.top)+(sourceHeight/2)-arrowSize,width:arrowSize}).find('div').css({borderBottomColor:'transparent',borderTopColor:'transparent',borderLeftWidth:position=='right'?0:arrowSize,borderRightWidth:position=='left'?0:arrowSize}).filter('.mgExternal-arrow-front').css({left:(position=='left'?'-':'')+this.$data.css('borderBottomWidth'),top:0})}}else if(this.$tooltipArrow){this.$tooltipArrow.hide()}this.$container.css(a)}}})(jQuery);