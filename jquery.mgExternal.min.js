/**
 * mgExternal 1.0.21
 *
 * Copyright 2012 Ricard Osorio Ma√±anas
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */
(function(d,s){d.fn.mgExternal=function(a,b){return this.each(function(){d(this).data("mgExternal",mgExternal(this,a,b))})};window.mgExternal=function(a,b,c){if(!(this instanceof mgExternal))return new mgExternal(a,b,c);if(!a||a.tagName===s)c=b,b=a,a=null;"object"==typeof b&&(c=b,b=null);this.settings={display:"modal",auto:!a,renew:c&&c.tooltip&&"hover"==c.tooltip.bind?!1:!0,autoFocus:!0,outsideClose:!0,escClose:!0,destroyOnClose:!a,css:{},extraClass:c&&c.display?"inline"!=c.display?"mgE-"+c.display:null:"mgE-modal",activeClass:"active",showDelay:c&&"tooltip"==c.display&&c.tooltip&&"hover"==c.tooltip.bind?200:0,hideDelay:c&&"tooltip"==c.display&&c.tooltip&&"hover"==c.tooltip.bind?200:0,showSpeed:300,hideSpeed:300,overlayShow:!c||!c.display||"modal"==c.display?!0:!1,overlayColor:"#fff",overlayOpacity:0.7,overlayShowSpeed:300,overlayHideSpeed:300,submitIdentifier:'input[type="submit"]',focusPriority:[":not(:radio):input:visible:enabled:first"],zIndexContainer:999,zIndexTooltipTrigger:998,zIndexOverlay:997,ajaxUrl:null,ajaxData:{},modal:{animateSpeed:500},tooltip:{bind:"click",position:"top center",positionSource:d(a),distance:0,arrowSize:8,arrowDistance:15,arrowFrontColor:null,arrowBorderColor:null},onCreateElements:function(){},onBeforeShow:function(){},onShow:function(){},onBeforeClose:function(){},onClose:function(){},onDestroy:function(){},onContentReady:function(){},onJsonData:function(){}};d.extend(!0,this.settings,this.defaults,c,d(a).data("mgExternal"));this.$trigger=d(a);this.$container=null;this.$content="inline"==c.display?this.$trigger:null;this.$tooltipArrow=null;this._defaultContent=b;this._defaultAjaxUrl=this.settings.ajaxUrl;this._lastSubmitName=null;this._show=!1;this._triggerZIndexBackup=null;if(this.$trigger){var f=this;switch(this.settings.display){case "modal":this.$trigger.bind("click",function(a){f.open(f.settings.showDelay);a.preventDefault();a.stopPropagation()});break;case "tooltip":switch(this.settings.tooltip.bind){case "click":this.$trigger.bind("click",function(a){f.isVisible()?f.close():f.open(f.settings.showDelay);a.preventDefault();a.stopPropagation()});break;case "hover":this.$trigger.bind({mouseenter:function(){f.open(f.settings.showDelay)},mouseleave:function(){f.close(f.settings.hideDelay)},mouseup:function(a){a.stopPropagation()}});break;case "focus":this.$trigger.bind({focus:function(){f.open(f.settings.showDelay)},blur:function(){f.close(f.settings.hideDelay)},mouseup:function(a){a.stopPropagation()}})}break;case "inline":this.bindSpecialActions()}}this.settings.auto&&this.open()};mgExternal.prototype={defaults:{},isVisible:function(){return"inline"==this.settings.display?!0:this.$container&&this.$container.is(":visible")&&"hidden"!=this.$container.css("visibility")},open:function(a){var b=this;this._show=!0;a?setTimeout(function(){b._open()},a):this._open()},_open:function(){if(this._show){var a=this;this.$trigger.addClass(this.settings.activeClass);if(this.settings.renew||!this.$container){this.settings.ajaxUrl=this._defaultAjaxUrl;this._lastSubmitName=null;var b=this.settings.ajaxUrl||this.$trigger.attr("href");this._defaultContent?this.setContent(this._defaultContent):b.match(/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i)?(this.setContent('<img src="'+b+'" style="display:block;" />'),setTimeout(function(){a.moveContainer()},1E3)):this.loadAjaxContent()}else this.showContainer()}},close:function(a){var b=this;this._show=!1;a?setTimeout(function(){b._close()},a):this._close()},_close:function(){if(!this._show&&!("inline"==this.settings.display||!this.isVisible()||!1===this.settings.onBeforeClose.call(this))){var a=this;this.$trigger.removeClass(this.settings.activeClass);this.$container.fadeOut(this.settings.hideSpeed,function(){a.settings.destroyOnClose&&a.destroy();"modal"==a.settings.display&&a.settings.overlayShow?d("#mgExternal-overlay").fadeOut(a.settings.overlayHideSpeed,function(){a.settings.onClose.call(a)}):a.settings.onClose.call(a)});"tooltip"==this.settings.display&&this.settings.overlayShow&&d("#mgExternal-overlay").fadeOut(this.settings.overlayHideSpeed,function(){a.$trigger.css({position:a._triggerZIndexBackup.position,zIndex:a._triggerZIndexBackup.zIndex})})}},setContent:function(a){!this.$container&&"inline"!=this.settings.display&&this.createElements();this.$content.html(a).children().css({marginLeft:0,marginRight:0}).first().css("margin-top","0").end().last().css("margin-bottom","0");this.isVisible()||this.$container.css("visibility","hidden").show();this.bindSpecialActions();this.setFocus();this.settings.onContentReady.call(this);"inline"!=this.settings.display&&(this.isVisible()?this.moveContainer():(this.$container.hide().css("visibility","visible"),this.showContainer()))},showContainer:function(){if(!1!==this.settings.onBeforeShow.call(this)){var a=this;if("tooltip"==this.settings.display&&this.settings.overlayShow)this._triggerZIndexBackup={position:"static"==this.$trigger.css("position")?"":this.$trigger.css("position"),zIndex:0==this.$trigger.css("z-index")?"":this.$trigger.css("z-index")},this.$trigger.css({position:this._triggerZIndexBackup.position?null:"relative",zIndex:this.settings.zIndexTooltipTrigger});var b=function(){a.$container.fadeIn(a.settings.showSpeed,function(){a.setFocus();a.settings.onShow.call(a)})};if(this.settings.overlayShow){var c=d("#mgExternal-overlay");c.css({background:this.settings.overlayColor,opacity:this.settings.overlayOpacity});"modal"==this.settings.display?c.fadeIn(this.settings.overlayShowSpeed,b):(c.fadeIn(this.settings.overlayShowSpeed),b())}else b();this.moveContainer(!0);this.$container.find("img").bind("load",function(){a.moveContainer(!0)})}},destroy:function(){this.$container.remove();this.settings.onDestroy.call(this)},bindSpecialActions:function(){var a=this;this.$content.find("form").bind("submit",function(b){a.loadAjaxContent(d(this));b.preventDefault()});this.$content.find(".mgExternal-redirect").bind("click",function(b){a.settings.ajaxUrl=d(this).attr("href");a.loadAjaxContent();b.preventDefault()});this.$content.find(".mgExternal-close").bind("click",function(b){a.close();b.preventDefault()});var b=this.$content.find(".mgExternal-onLoad").data("mgExternal-onLoad");b&&b.call(this)},loadAjaxContent:function(a){var b=this,c=d.extend({},b.settings.ajaxData);if(a)this._lastSubmitName=a.find(this.settings.submitIdentifier).val(),a.find(":input").each(function(){d(this).is(":checkbox")?c[d(this).attr("name")]=d(this).prop("checked")?1:0:d(this).is(":radio")?d(this).prop("checked")&&(c[d(this).attr("name")]=d(this).val()):c[d(this).attr("name")]=d(this).val()});if(a&&"multipart/form-data"==a.attr("enctype")){var f="mgExternal-iframe"+Math.floor(99999*Math.random());d('<iframe name="'+f+'" id="'+f+'" src="" style="display:none;"></iframe>').appendTo("body").bind("load",function(){var a=d(this).contents().find("body").html();try{var c=eval("("+a+")");if("object"==typeof c){b.settings.onJsonData.call(b,c);return}}catch(e){}b.setContent(a)});a.clone().insertAfter(a);d.each(this.settings.ajaxData,function(b,c){a.append('<input type="hidden" name="'+b+'" value="'+c+'" />')});a.appendTo(d("#"+f)).attr("action",this.settings.ajaxUrl||this.$trigger.attr("href")).attr("target",f).append('<input type="hidden" name="is_iframe" value="true" />').unbind("submit").trigger("submit")}else d.ajax({url:this.settings.ajaxUrl||this.$trigger.attr("href"),type:a?"POST":"GET",data:c,success:function(a){"object"==typeof a?b.settings.onJsonData.call(b,a):b.setContent(a)},error:function(){b.setContent('<div class="notice alert">S\'ha produ\u00eft un error</div>')}});this.$content&&this.$content.find(":input").prop("disabled",!0).addClass("disabled")},setFocus:function(){if(this.settings.autoFocus){var a=this.$content.find(this.settings.submitIdentifier+'[value="'+this._lastSubmitName+'"]').parents("form:visible");0==a.length&&(a=this.$content.find("form:first:visible"));if(0==a.length)a=this.$content;for(var b=0,c=a.find(this.settings.focusPriority[b]);0==c.length&&b<=this.settings.focusPriority.length;c=a.find(this.settings.focusPriority[++b]));setTimeout(function(){c.trigger("focus")},10)}},createElements:function(){var a=this;if(!this.$container)this.$container=d("<div/>").addClass("mgExternal-container").addClass(this.settings.extraClass).css({position:"absolute",zIndex:this.settings.zIndexContainer}).hide().appendTo("body").bind("mouseup",function(a){a.stopPropagation()}),this.$content=d("<div/>").addClass("mgExternal-content").css(this.settings.css).appendTo(this.$container),"hover"==this.settings.tooltip.bind&&(this.$container.bind("mouseenter",function(){a.open(a.settings.showDelay)}),this.$container.bind("mouseleave",function(){a.close(a.settings.hideDelay)})),d(window).bind("resize",function(){a.moveContainer()}),"tooltip"==this.settings.display&&d(window).bind("scroll",function(){a.moveContainer()}),this.settings.outsideClose&&d("body").bind("mouseup",function(b){1==b.which&&a.close()}),this.settings.escClose&&d(document).bind("keyup",function(b){27==b.keyCode&&a.close()}),a.settings.onCreateElements.call(a);if(this.settings.overlayShow&&0==d("#mgExternal-overlay").length)this.$modalOverlay=d("<div/>").attr("id","mgExternal-overlay").css({height:"100%",left:0,position:"fixed",top:0,width:"100%",zIndex:this.settings.zIndexOverlay}).hide().appendTo("body");if(!this.$tooltipArrow&&"tooltip"==this.settings.display&&this.settings.tooltip.arrowSize)this.$tooltipArrow=d("<div/>").addClass("mgExternal-arrow").css({position:"absolute"}).appendTo(this.$container).append(d("<div/>").addClass("mgExternal-arrow-shadow").css({borderColor:this.settings.tooltip.arrowBorderColor,borderStyle:"solid",borderWidth:this.settings.tooltip.arrowSize})).append(d("<div/>").addClass("mgExternal-arrow-front").css({borderColor:this.settings.tooltip.arrowFrontColor||this.$content.css("backgroundColor"),borderStyle:"solid",position:"absolute",borderWidth:this.settings.tooltip.arrowSize}))},moveContainer:function(a){if(a||this.isVisible())switch(this.settings.display){case "modal":this.moveModal();break;case "tooltip":this.moveTooltip()}},moveModal:function(){var a=0,b=0,b=this.$container.outerHeight(!0),c=this.$container.outerWidth(!0);b<d(window).height()&&(a=d(document).scrollTop()+(d(window).height()-b)/2-15);a<d(document).scrollTop()+15&&(a=d(document).scrollTop()+15);b=(d(window).width()-c)/2;15>b&&(b=15);0<this.settings.modal.animateSpeed?this.$container.stop().animate({top:a,left:b,opacity:1},this.settings.modal.animateSpeed):this.$container.css({top:a,left:b,opacity:1})},moveTooltip:function(){var a,b,c,f,m,k,e=this.$container.clone();e.css({left:0,top:0,position:"absolute",visibility:"hidden"}).children().css({height:"",width:""}).end().appendTo("body");this.$content.css("height",this.settings.css.height||"").css("height",e.children().height()).css("width",this.settings.css.width||"").css("width",e.children().width());e.remove();var e={top:0,left:0},j=d(window).height(),v=d(window).width(),n=this.$container.outerHeight(!0),o=this.$container.outerWidth(!0),i=this.settings.tooltip.positionSource.offset(),p=this.settings.tooltip.positionSource.outerHeight(),q=this.settings.tooltip.positionSource.outerWidth(),r=this.settings.tooltip.distance,g=this.settings.tooltip.arrowSize,l=this.settings.tooltip.arrowDistance,t=d(document).scrollTop(),u=d(document).scrollLeft(),h=this.settings.tooltip.position.split(" ")[0],s=this.settings.tooltip.position.split(" ")[1];"bottom"==h&&j<i.top-t+p+n+15&&(h="top");"top"==h&&i.top-t-15<n&&(h="bottom");"right"==h&&v<i.left-u+q+o+15&&(h="left");"left"==h&&i.left-u-15<o&&(h="right");switch(h){case "top":e.top=i.top-n-r-g;break;case "bottom":e.top=i.top+p+r+g;break;case "left":e.left=i.left-o-r-g;break;case "right":e.left=i.left+q+r+g}switch(s){case "top":e.top=i.top;break;case "middle":e.top=i.top-n/2+p/2;break;case "bottom":e.top=i.top-n+p;break;case "left":e.left=i.left;break;case "center":e.left=i.left-o/2+q/2;break;case "right":e.left=i.left-o+q}for("left"==h||"right"==h?(a="top",b=p,c=i.top,f=n,m=j,k=t):(a="left",b=q,c=i.left,f=o,m=v,k=u);e[a]-k+f+15>m;)if(j=!1,f>=b?e[a]+f>c+b&&(j=!0):e[a]>c&&(j=!0),j)e[a]--;else break;for(;15>e[a]-k;)if(j=!1,f>=b?e[a]<c&&(j=!0):e[a]+f<c+b&&(j=!0),j)e[a]++;else break;if(g&&b<g+2*l&&(m=c+b/2-g-e[a],k=e[a]+f-c-b/2-g,!(m<l&&k<l)&&(m<l&&(e[a]=c+b/2-g-l),k<l&&(e[a]=c-f+b/2+g+l),m=c+b/2-g-e[a],k=e[a]+f-c-b/2-g,m<l||k<l)))e[a]=c-(f-2*g)/2;g?(this.$tooltipArrow||this.createElements(),this.$tooltipArrow.show(),"top"==h||"bottom"==h?this.$tooltipArrow.css({height:g,left:o<q?o/2-g:i.left-e.left+q/2-g,top:"top"==h?"":-g,width:2*g}).find("div").css({borderLeftColor:"transparent",borderRightColor:"transparent",borderBottomWidth:"top"==h?0:g,borderTopWidth:"bottom"==h?0:g}).filter(".mgExternal-arrow-front").css({left:0,top:("top"==h?"-":"")+this.$content.css("borderBottomWidth")}):this.$tooltipArrow.css({height:2*g,left:"left"==h?"":-g,right:"right"==h?"":-g,top:n<p?n/2-g:i.top-e.top+p/2-g,width:g}).find("div").css({borderBottomColor:"transparent",borderTopColor:"transparent",borderLeftWidth:"right"==h?0:g,borderRightWidth:"left"==h?0:g}).filter(".mgExternal-arrow-front").css({left:("left"==h?"-":"")+this.$content.css("borderBottomWidth"),top:0})):this.$tooltipArrow&&this.$tooltipArrow.hide();this.$container.css(e)}};d(function(){var a=d("<div/>").css({height:100,overflow:"hidden",position:"absolute",width:100}).append(d("<div/>").css("height","100%")).appendTo("body");window.mgExternal.prototype._browserScrollbarWidth=a.find("> div").width()-a.css("overflow-y","scroll").find("> div").width();a.remove()})})(jQuery,window);