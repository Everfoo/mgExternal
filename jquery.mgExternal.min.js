/**
 * mgExternal 1.0.24
 *
 * Copyright 2012 Ricard Osorio Ma√±anas
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */
(function(d){d.fn.mgExternal=function(a,b){return this.each(function(){d(this).data("mgExternal",mgExternal(this,a,b))})};window.mgExternal=function(a,b,c){if(!(this instanceof mgExternal))return new mgExternal(a,b,c);if(!a||!a.nodeType)c=b,b=a,a=null;"object"==typeof b&&(c=b,b=null);this._unique=Math.random().toString().substr(2);mgExternal.instances.register(this,this._unique);this.settings={display:"modal",auto:!a,renew:!0,autoFocus:!0,outsideClose:!0,escClose:!0,destroyOnClose:!a,css:{},extraClass:c&&c.display?"inline"!=c.display?"mgE-"+c.display:null:"mgE-modal",activeClass:"active",loadingClass:"loading",showDelay:c&&"tooltip"==c.display&&c.tooltip&&"hover"==c.tooltip.bind?200:0,hideDelay:c&&"tooltip"==c.display&&c.tooltip&&"hover"==c.tooltip.bind?200:0,showSpeed:300,hideSpeed:300,overlayShow:!c||!c.display||"modal"==c.display?!0:!1,overlayColor:"#fff",overlayOpacity:0.7,overlayShowSpeed:300,overlayHideSpeed:300,submitIdentifier:'input[type="submit"]',focusPriority:[":not(:radio):input:visible:enabled:first"],zIndexContainer:999,zIndexTooltipTrigger:998,zIndexOverlay:997,breatheSeparation:c&&"tooltip"==c.display?15:30,ajaxUrl:null,ajaxData:{"mgExternal-unique":this._unique},modal:{animateSpeed:500},tooltip:{bind:"click",position:"top center",positionSource:d(a),distance:0,arrowSize:8,arrowDistance:15,arrowFrontColor:null,arrowBorderColor:null},onCreateElements:function(){},onBeforeShow:function(){},onShow:function(){},onBeforeClose:function(){},onClose:function(){},onDestroy:function(){},onContentReady:function(){},onJsonData:function(){}};d.extend(!0,this.settings,this.defaults,c,d(a).data("mgExternal"));this.$trigger=d(a);this.$container=null;this.$content=c&&"inline"==c.display?this.$trigger:null;this.$tooltipArrow=null;this._defaultContent=b;this._defaultAjaxUrl=this.settings.ajaxUrl;this._lastSubmitName=null;this._show=!1;this._triggerZIndexBackup=null;this._preventNextMouseUp=!1;if(this.$trigger){var f=this;switch(this.settings.display){case "modal":this.$trigger.bind("click",function(a){f.open(f.settings.showDelay);a.preventDefault();a.stopPropagation()});break;case "tooltip":switch(this.settings.tooltip.bind){case "click":this.$trigger.bind("click",function(a){f.isVisible()?f.close():f.open(f.settings.showDelay);a.preventDefault();a.stopPropagation()});break;case "hover":this.$trigger.bind({mouseenter:function(){f.open(f.settings.showDelay)},mouseleave:function(){f.close(f.settings.hideDelay)},mouseup:function(a){a.stopPropagation()}});break;case "focus":this.$trigger.bind({focus:function(){f.open(f.settings.showDelay)},blur:function(){f.close(f.settings.hideDelay)},mouseup:function(a){a.stopPropagation()}})}break;case "inline":this.bindSpecialActions()}}this.settings.auto&&this.open()};mgExternal.instances={_instances:{},register:function(a,b){this._instances[b]=a},get:function(a){return this._instances[a]}};mgExternal.prototype={defaults:{},isVisible:function(){return"inline"==this.settings.display?!0:this.$container&&this.$container.is(":visible")},open:function(a){var b=this;this._show=!0;a?setTimeout(function(){b._open()},a):this._open()},_open:function(){if(this._show)if(this.settings.renew||!this.$container){this.settings.ajaxUrl=this._defaultAjaxUrl;this._lastSubmitName=null;var a=this.settings.ajaxUrl||this.$trigger.attr("href");this._defaultContent?this.setContent(this._defaultContent):a.match(/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i)?this.setContent('<img src="'+a+'" style="display:block;" />'):this.loadAjaxContent()}else this.showContainer()},close:function(a){var b=this;this._show=!1;a?setTimeout(function(){b._close()},a):this._close()},_close:function(){if(!this._show&&!("inline"==this.settings.display||!this.isVisible()||!1===this.settings.onBeforeClose.call(this))){var a=this;this.$trigger.removeClass(this.settings.loadingClass).removeClass(this.settings.activeClass);this.$container.fadeOut(this.settings.hideSpeed,function(){a.settings.destroyOnClose&&a.destroy();"modal"==a.settings.display&&a.settings.overlayShow?(a.$container.parent().hide(),d("body").css({marginRight:"",overflow:""}),d("#mgExternal-overlay").fadeOut(a.settings.overlayHideSpeed,function(){a.settings.onClose.call(a)})):a.settings.onClose.call(a)});"tooltip"==this.settings.display&&this.settings.overlayShow&&d("#mgExternal-overlay").fadeOut(this.settings.overlayHideSpeed,function(){a.$trigger.css({position:a._triggerZIndexBackup.position,zIndex:a._triggerZIndexBackup.zIndex})})}},setContent:function(a){var b=this;!this.$container&&"inline"!=this.settings.display&&this.createElements();this.$content.clone().appendTo(this.$container);this.$content.html(a).css({left:0,top:0,position:"absolute",visibility:"hidden"}).children().css({marginLeft:0,marginRight:0}).first().css("margin-top","0").end().last().css("margin-bottom","0").end().end().appendTo("body");this.bindSpecialActions();this.settings.onContentReady.call(this);var c=function(){b.$container.empty();b.$content.css({left:"",top:"",position:"",visibility:""}).appendTo(b.$container);b.isVisible()&&b.setFocus();b.showContainer()},d=this.$content.find("img");if(d.length){var m=0;d.on("load",function(){++m>=d.length&&c()})}else c()},showContainer:function(){if(!("inline"==this.settings.display||!1===this.settings.onBeforeShow.call(this))){if(this.isVisible())return this.moveContainer();var a=this;this.$trigger.addClass(this.settings.activeClass);"tooltip"==this.settings.display&&this.settings.overlayShow&&(this._triggerZIndexBackup={position:"static"==this.$trigger.css("position")?"":this.$trigger.css("position"),zIndex:0==this.$trigger.css("z-index")?"":this.$trigger.css("z-index")},this.$trigger.css({position:this._triggerZIndexBackup.position?null:"relative",zIndex:this.settings.zIndexTooltipTrigger}));var b=function(){a.settings.display=="modal"&&a.settings.overlayShow&&a.$container.parent().show();a.moveContainer(true,true);a.$container.fadeIn(a.settings.showSpeed,function(){a.setFocus();a.settings.onShow.call(a)})};if(this.settings.overlayShow){var c=d("#mgExternal-overlay");c.css({background:this.settings.overlayColor,opacity:this.settings.overlayOpacity});"modal"==this.settings.display?(d("body").css({marginRight:this._browserScrollbarWidth,overflow:"hidden"}),c.fadeIn(this.settings.overlayShowSpeed,b)):(c.fadeIn(this.settings.overlayShowSpeed),b())}else b()}},destroy:function(){"modal"==this.settings.display&&this.settings.overlayShow?this.$container.parent().remove():this.$container.remove();this.settings.onDestroy.call(this)},bindSpecialActions:function(){var a=this;this.$content.find("form").bind("submit",function(b){a.loadAjaxContent(d(this));b.preventDefault()});this.$content.find(".mgExternal-redirect").bind("click",function(b){d(this).addClass(a.settings.loadingClass);a.settings.ajaxUrl=d(this).attr("href");a.loadAjaxContent();b.preventDefault()});this.$content.find(".mgExternal-close").bind("click",function(b){a.close();b.preventDefault()})},loadAjaxContent:function(a){var b=this,c=d.extend({},b.settings.ajaxData);this.$trigger.addClass(this.settings.loadingClass);a&&(this._lastSubmitName=a.find(this.settings.submitIdentifier).val(),a.find(":input").each(function(){d(this).is(":checkbox")?c[d(this).attr("name")]=d(this).prop("checked")?1:0:d(this).is(":radio")?d(this).prop("checked")&&(c[d(this).attr("name")]=d(this).val()):c[d(this).attr("name")]=d(this).val()}));if(a&&"multipart/form-data"==a.attr("enctype")){var f="mgExternal-iframe"+Math.floor(99999*Math.random());d('<iframe name="'+f+'" id="'+f+'" src="" style="display:none;"></iframe>').appendTo("body").bind("load",function(){b.$trigger.removeClass(b.settings.loadingClass);var a=d(this).contents().find("body").html();try{var c=eval("("+a+")");if(typeof c=="object"){b.settings.onJsonData.call(b,c);return}}catch(e){}b.setContent(a)});a.clone().insertAfter(a);d.each(this.settings.ajaxData,function(b,c){a.append('<input type="hidden" name="'+b+'" value="'+c+'" />')});a.appendTo(d("#"+f)).attr("action",this.settings.ajaxUrl||this.$trigger.attr("href")).attr("target",f).append('<input type="hidden" name="is_iframe" value="true" />').unbind("submit").trigger("submit")}else d.ajax({url:this.settings.ajaxUrl||this.$trigger.attr("href"),type:a?"POST":"GET",data:c,success:function(a){b.$trigger.removeClass(b.settings.loadingClass);typeof a=="object"?b.settings.onJsonData.call(b,a):b.setContent(a)},error:function(){b.$trigger.removeClass(b.settings.loadingClass);b.setContent('<div class="notice alert">S\'ha produ\u00eft un error</div>')}});this.$content&&this.$content.find(":input").prop("disabled",!0).addClass("disabled")},setFocus:function(){if(this.settings.autoFocus){var a=this.$content.find(this.settings.submitIdentifier+'[value="'+this._lastSubmitName+'"]').parents("form:visible");0==a.length&&(a=this.$content.find("form:first:visible"));0==a.length&&(a=this.$content);for(var b=0,c=a.find(this.settings.focusPriority[b]);0==c.length&&b<=this.settings.focusPriority.length;c=a.find(this.settings.focusPriority[++b]));setTimeout(function(){c.trigger("focus")},10)}},createElements:function(){var a=this;this.$container||(this.$container=d("<div/>").addClass("mgExternal-container").addClass(this.settings.extraClass).css({position:"absolute",zIndex:this.settings.zIndexContainer}).hide().appendTo("modal"==this.settings.display&&this.settings.overlayShow?d("<div/>").css({height:"100%",left:0,overflowY:"scroll",position:"fixed",top:0,width:"100%",zIndex:this.settings.zIndexContainer}).appendTo("body"):"body").bind("mouseup",function(){a._preventNextMouseUp=!0}),this.$content=d("<div/>").addClass("mgExternal-content").css(this.settings.css).appendTo(this.$container),"hover"==this.settings.tooltip.bind&&(this.$container.bind("mouseenter",function(){a.open(a.settings.showDelay)}),this.$container.bind("mouseleave",function(){a.close(a.settings.hideDelay)})),d(window).bind("resize",function(){a.moveContainer()}),"tooltip"==this.settings.display&&d(window).bind("scroll",function(){a.moveContainer()}),this.settings.outsideClose&&d("body").bind("mouseup",function(b){a._preventNextMouseUp?a._preventNextMouseUp=false:b.which==1&&(!b.originalEvent.originalTarget||!(b.originalEvent.originalTarget instanceof XULElement))&&a.close()}),this.settings.escClose&&d(document).bind("keyup",function(b){b.keyCode==27&&a.close()}),a.settings.onCreateElements.call(a));this.settings.overlayShow&&0==d("#mgExternal-overlay").length&&d("<div/>").attr("id","mgExternal-overlay").css({height:"100%",left:0,position:"fixed",top:0,width:"100%",zIndex:this.settings.zIndexOverlay}).hide().appendTo("body");!this.$tooltipArrow&&"tooltip"==this.settings.display&&this.settings.tooltip.arrowSize&&(this.$tooltipArrow=d("<div/>").addClass("mgExternal-arrow").css({position:"absolute"}).appendTo(this.$container).append(d("<div/>").addClass("mgExternal-arrow-shadow").css({borderColor:this.settings.tooltip.arrowBorderColor,borderStyle:"solid",borderWidth:this.settings.tooltip.arrowSize})).append(d("<div/>").addClass("mgExternal-arrow-front").css({borderColor:this.settings.tooltip.arrowFrontColor||this.$content.css("backgroundColor"),borderStyle:"solid",position:"absolute",borderWidth:this.settings.tooltip.arrowSize})))},moveContainer:function(a,b){if(a||this.isVisible())switch(this.settings.display){case "modal":this.moveModal(b);break;case "tooltip":this.moveTooltip()}},moveModal:function(a){var b=0,c=0,c=this.settings.breatheSeparation;this.$container.css("padding",c+"px 0 "+2*c+"px");var c=this.$container.outerHeight(!0),f=this.$container.outerWidth(!0),m=d(window).height(),j=d(window).width(),e=this.settings.overlayShow?0:d(document).scrollTop();this.settings.overlayShow&&(f+=this._browserScrollbarWidth);c<m&&(b=e+(m-c)/2);b<e&&(b=e);c=(j-f)/2;0>c&&(c=0);0<this.settings.modal.animateSpeed&&!a?this.$container.stop().animate({top:b,left:c,opacity:1},this.settings.modal.animateSpeed):this.$container.stop().css({top:b,left:c,opacity:1})},moveTooltip:function(){var a,b,c,f,m,j;if(!this.settings.css.height||!this.settings.css.width){var e=this.$content.clone();e.css({left:0,top:0,position:"absolute",visibility:"hidden",height:this.settings.css.height||"",width:this.settings.css.width||""}).show().appendTo("body");this.$content.css({width:e.width()});e.remove()}var e={top:0,left:0},k=this.settings.breatheSeparation;m=d(window).height();var s=d(window).width(),o=this.$container.outerHeight(!0),p=this.$container.outerWidth(!0),i=this.settings.tooltip.positionSource.offset(),q=this.settings.tooltip.positionSource.outerHeight(),r=this.settings.tooltip.positionSource.outerWidth();a=this.settings.tooltip.distance;var g=this.settings.tooltip.arrowSize,n=this.settings.tooltip.arrowDistance;j=d(document).scrollTop();var l=d(document).scrollLeft(),h=this.settings.tooltip.position.split(" ")[0];b=this.settings.tooltip.position.split(" ")[1];"bottom"==h&&m<i.top-j+q+o+k&&(h="top");"top"==h&&i.top-j-k<o&&(h="bottom");"right"==h&&s<i.left-l+r+p+k&&(h="left");"left"==h&&i.left-l-k<p&&(h="right");switch(h){case "top":e.top=i.top-o-a-g;break;case "bottom":e.top=i.top+q+a+g;break;case "left":e.left=i.left-p-a-g;break;case "right":e.left=i.left+r+a+g}switch(b){case "top":e.top=i.top;break;case "middle":e.top=i.top-o/2+q/2;break;case "bottom":e.top=i.top-o+q;break;case "left":e.left=i.left;break;case "center":e.left=i.left-p/2+r/2;break;case "right":e.left=i.left-p+r}"left"==h||"right"==h?(a="top",b=q,c=i.top,f=o):(a="left",b=r,c=i.left,f=p,m=s,j=l);for(;e[a]-j+f+k>m;)if(l=!1,f>=b?e[a]+f>c+b&&(l=!0):e[a]>c&&(l=!0),l)e[a]--;else break;for(;e[a]-j<k;)if(l=!1,f>=b?e[a]<c&&(l=!0):e[a]+f<c+b&&(l=!0),l)e[a]++;else break;if(g&&b<g+2*n&&(k=c+b/2-g-e[a],j=e[a]+f-c-b/2-g,!(k<n&&j<n)&&(k<n&&(e[a]=c+b/2-g-n),j<n&&(e[a]=c-f+b/2+g+n),k=c+b/2-g-e[a],j=e[a]+f-c-b/2-g,k<n||j<n)))e[a]=c-(f-2*g)/2;g?(this.$tooltipArrow||this.createElements(),this.$tooltipArrow.show(),"top"==h||"bottom"==h?this.$tooltipArrow.css({bottom:"top"==h?-g:"",height:g,left:p<r?p/2-g:i.left-e.left+r/2-g,top:"top"==h?"":-g,width:2*g}).find("div").css({borderLeftColor:"transparent",borderRightColor:"transparent",borderBottomWidth:"top"==h?0:g,borderTopWidth:"bottom"==h?0:g}).filter(".mgExternal-arrow-front").css({left:0,top:("top"==h?"-":"")+this.$content.css("borderBottomWidth")}):this.$tooltipArrow.css({bottom:"",height:2*g,left:"left"==h?"":-g,right:"right"==h?"":-g,top:o<q?o/2-g:i.top-e.top+q/2-g,width:g}).find("div").css({borderBottomColor:"transparent",borderTopColor:"transparent",borderLeftWidth:"right"==h?0:g,borderRightWidth:"left"==h?0:g}).filter(".mgExternal-arrow-front").css({left:("left"==h?"-":"")+this.$content.css("borderBottomWidth"),top:0})):this.$tooltipArrow&&this.$tooltipArrow.hide();this.$container.css(e)}};d(function(){var a=d("<div/>").css({height:100,overflow:"hidden",position:"absolute",width:100}).append(d("<div/>").css("height","100%")).appendTo("body");window.mgExternal.prototype._browserScrollbarWidth=a.find("> div").width()-a.css("overflow-y","scroll").find("> div").width();a.remove()})})(jQuery,window);