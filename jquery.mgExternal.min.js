/**
 * mgExternal 1.0.9
 * www.magicalglobe.com/projects/mgExternal
 *
 * Copyright 2011 Ricard Osorio Mañanas
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */
(function($){$.fn.mgExternal=function(a,b){return this.each(function(){$(this).data('mgExternal',mgExternal(this,a,b))})};window.mgExternal=function(b,c,d){if(!(this instanceof mgExternal))return new mgExternal(b,c,d);if(b.tagName==undefined){d=c;c=b;b=null}if(typeof c=='object'){d=c;c=null}this.settings={display:'modal',content:(d&&d.display=='inline')?$(b):$('<div/>').html(c||""),auto:!b,renew:(d&&d.tooltip&&d.tooltip.bind=='hover')?false:true,autoFocus:true,outsideClose:true,escClose:true,destroyOnClose:!b,dataCss:{},extraClass:(d&&d.display)?(d.display!='inline'?d.display:null):'modal',showDelay:0,hideDelay:0,showSpeed:300,hideSpeed:300,overlayColor:'#fff',overlayOpacity:(!d||!d.display||d.display=='modal')?0.7:0,focusPriority:[':not(:radio):input:visible:enabled:first'],ajaxUrl:null,ajaxData:{},tooltip:{bind:'click',position:'top center',positionFrom:(d&&d.tooltip&&d.tooltip.arrowSize==0)?'limit':'center',positionSource:$(b),distance:0,arrowSize:9,arrowDistance:15,arrowFrontColor:null,arrowBorderColor:null,fitWindow:true,activeClass:'active'},onCreate:function(){},onBeforeShow:function(){},onShow:function(){},onBeforeClose:function(){},onClose:function(){},onDestroy:function(){},onContentReady:function(){},onJsonData:function(a){}};$.extend(true,this.settings,this.defaults,d,$(b).data('mgExternal'));this.$trigger=$(b);this.$container=null;this.$data=null;this.$content=this.settings.content;this.$tooltipArrow=null;this._defaultContent=c;this._defaultAjaxUrl=this.settings.ajaxUrl;this._isContentLoaded=!!this.$content.html();this._lastSubmitName=null;this._show=false;this._triggerZIndexBackup=null;if(this.$trigger){var f=this;switch(this.settings.display){case'modal':this.$trigger.bind('click',function(e){f.show(f.settings.showDelay);e.preventDefault();e.stopPropagation()});break;case'tooltip':switch(this.settings.tooltip.bind){case'click':this.$trigger.bind('click',function(e){if(f.$container&&f.$container.is(':visible')){f.hide(f.settings.hideDelay)}else{f.show(f.settings.showDelay)}e.preventDefault();e.stopPropagation()});break;case'hover':this.$trigger.bind({mouseenter:function(){f.show(f.settings.showDelay)},mouseleave:function(){f.hide(f.settings.hideDelay)},mouseup:function(e){e.stopPropagation()}});break;case'focus':this.$trigger.bind({focus:function(){f.show(f.settings.showDelay)},blur:function(){f.hide(f.settings.hideDelay)},mouseup:function(e){e.stopPropagation()}});break}break;case'inline':this.bindSpecialActions();break}}if(this.settings.auto)this.show()};mgExternal.prototype={defaults:{},show:function(b){if(this.settings.display=='inline')return;var c=this;this._show=true;setTimeout(function(){if(c._show&&c.settings.onBeforeShow.call(c)!==false){if(!c._isContentLoaded){c.settings.ajaxUrl=c._defaultAjaxUrl;c._lastSubmitName=null;c.loadContent(false,!c.$content.html()||!c._defaultContent);c._isContentLoaded=true}else{c.$trigger.addClass(c.settings.tooltip.activeClass);if(c.settings.display=='tooltip'){c._triggerZIndexBackup={position:c.$trigger.css('position'),zIndex:c.$trigger.css('z-index')};c.$trigger.css({position:c._triggerZIndexBackup.position=='static'?'relative':null,zIndex:999})}if(!c.$container)c.createElements();var a=function(){c.$container.fadeIn(c.settings.showSpeed,function(){c.settings.onShow.call(c);if(c.settings.autoFocus)c.focus()})};if(c.settings.overlayOpacity>0){$('#mgExternal-overlay').css({background:c.settings.overlayColor,opacity:c.settings.overlayOpacity});if(c.settings.display=='modal'){$('#mgExternal-overlay').fadeIn(c.settings.showSpeed,a)}else{$('#mgExternal-overlay').fadeIn(c.settings.showSpeed);a()}}else{a()}c.moveContainer();c.$container.find('img').load(function(){c.moveContainer()})}}},b)},hide:function(a){if(this.settings.display=='inline')return;var b=this;this._show=false;if(!this.$container||!this.$container.is(':visible'))return;setTimeout(function(){if(!b._show&&b.$container&&b.settings.onBeforeClose.call(b)!==false){b.$trigger.removeClass(b.settings.tooltip.activeClass);if(b.settings.display=='tooltip'){b.$trigger.css({position:b._triggerZIndexBackup.position,zIndex:b._triggerZIndexBackup.zIndex})}if(b.settings.renew)b._isContentLoaded=false;b.$container.fadeOut(b.settings.hideSpeed,function(){if(b.settings.destroyOnClose)b.destroy();if(b.settings.overlayOpacity>0&&b.settings.display=='modal'){$('#mgExternal-overlay').fadeOut(b.settings.hideSpeed,function(){b.settings.onClose.call(b)})}else{b.settings.onClose.call(b)}});if(b.settings.overlayOpacity>0&&b.settings.display!='modal')$('#mgExternal-overlay').fadeOut(b.settings.hideSpeed)}},a)},destroy:function(){this.$container.remove();this.settings.onDestroy.call(this)},bindSpecialActions:function(){var a=this;this.$content.find('form').bind('submit',function(e){a.loadContent($(this));e.preventDefault()});this.$content.find('.mgExternal-reload').bind('click',function(e){a.loadContent(true);e.preventDefault()});this.$content.find('.mgExternal-redirect').bind('click',function(e){a.settings.ajaxUrl=$(this).attr('href');a.loadContent(false,true);e.preventDefault()});this.$content.find('.mgExternal-close').bind('click',function(e){a.hide();e.preventDefault()})},loadContent:function(d,e){var f=this,form=(typeof d=='object')?d:this.$content.find('form'),ajaxData=$.extend({},f.settings.ajaxData);if(d){this._lastSubmitName=form.find('input[type="submit"]').attr('name');form.find(':input').each(function(){if($(this).is(':checkbox')){ajaxData[$(this).attr('name')]=$(this).prop('checked')?1:0}else if($(this).is(':radio')){if($(this).prop('checked'))ajaxData[$(this).attr('name')]=$(this).val()}else{ajaxData[$(this).attr('name')]=$(this).val()}})}if(d||e){if(d&&form.attr('enctype')=='multipart/form-data'){var g='mgExternal-iframe'+Math.floor(Math.random()*99999);$('<iframe name="'+g+'" id="'+g+'" src="javascript:false;" style="display:none;"></iframe>').appendTo('body').bind('load',function(){var a=$(this).contents().find('body').contents();if(a.text()!='false')f.setContent($(this).contents().find('body').contents())});form.attr('action',this.settings.ajaxUrl||this.$trigger.attr('href')).attr('target',g).append('<input type="hidden" name="ajax" value="true" />').append('<input type="hidden" name="'+form.find(':submit').attr('name')+'" value="'+form.find(':submit').val()+'" />').unbind('submit').trigger('submit')}else{$.ajax({url:this.settings.ajaxUrl||this.$trigger.attr('href'),type:d?'POST':'GET',data:ajaxData,success:function(a){if(typeof a=='object'){f.settings.onJsonData.call(f,a)}else{f.setContent(a)}},error:function(a,b,c){f.setContent('<div class="notice alert" style="white-space:nowrap;">S\'ha produït un error - <a class="mgExternal-reload">Reintentar</a></div>')}})}this.$content.find(':input').prop('disabled',true)}else{this.show();this.bindSpecialActions()}},setContent:function(a){this._isContentLoaded=true;this.$content.html(a).find('> div').css('margin','0');if(this.$container&&this.$container.is(':visible')){if(this.settings.autoFocus)this.focus();this.moveContainer()}else if(this.settings.display=='inline'){if(this.settings.autoFocus)this.focus()}else{this.show()}this.bindSpecialActions();this.settings.onContentReady.call(this)},focus:function(){var a=this.$content.find('input[type="submit"][name="'+this._lastSubmitName+'"]').parents('form');if(a.length==0)a=this.$content.find('form:first');if(a.length==0)a=this.$content;for(var i=0,firstInput=a.find(this.settings.focusPriority[i]);firstInput.length==0&&i<=this.settings.focusPriority.length;firstInput=a.find(this.settings.focusPriority[++i]));setTimeout(function(){firstInput.trigger('focus')},10)},createElements:function(){var a=this;if(!this.$container){this.$container=$('<div/>').addClass('mgExternal-container').addClass(this.settings.extraClass).css({position:'absolute',zIndex:999}).hide().appendTo('body').bind('mouseup',function(e){e.stopPropagation()});this.$data=$('<div/>').addClass('mgExternal-data').css(this.settings.dataCss).appendTo(this.$container).append(this.$content);if(this.settings.tooltip.bind=='hover'){this.$container.bind('mouseenter',$.proxy(function(){this.show(this.settings.showDelay)},this));this.$container.bind('mouseleave',$.proxy(function(){this.hide(this.settings.hideDelay)},this))}$(window).bind('resize',function(){a.moveContainer()});if(this.settings.outsideClose){$('body').bind('mouseup',function(e){if(e.which==1)a.hide()})}if(this.settings.escClose){$(document).bind('keyup',function(e){if(e.keyCode==27)a.hide()})}a.settings.onCreate.call(a)}if(this.settings.overlayOpacity>0&&$('#mgExternal-overlay').length==0){this.$modalOverlay=$('<div/>').attr('id','mgExternal-overlay').css({height:'100%',left:0,position:'fixed',top:0,width:'100%',zIndex:998}).hide().appendTo('body')}if(!this.$tooltipArrow&&this.settings.display=='tooltip'&&this.settings.tooltip.arrowSize){this.$tooltipArrow=$('<div/>').addClass('mgExternal-arrow').css({position:'absolute'}).appendTo(this.$container).append($('<div/>').addClass('mgExternal-arrow-shadow').css({borderColor:this.settings.tooltip.arrowBorderColor,borderStyle:'solid',borderWidth:this.settings.tooltip.arrowSize})).append($('<div/>').addClass('mgExternal-arrow-front').css({borderColor:this.settings.tooltip.arrowFrontColor||this.$data.css('backgroundColor'),borderStyle:'solid',position:'absolute',borderWidth:this.settings.tooltip.arrowSize}))}},moveContainer:function(){switch(this.settings.display){case'modal':this.moveModal();break;case'tooltip':this.moveTooltip();break}},moveModal:function(){var a=0,left=0,containerHeight=this.$container.outerHeight(true),containerWidth=this.$container.outerWidth(true);if(containerHeight<$(window).height())a=$(document).scrollTop()+(($(window).height()-containerHeight)/2)-15;if(a<($(document).scrollTop()+15))a=$(document).scrollTop()+15;left=($(window).width()-containerWidth)/2;if(left<15)left=15;this.$container.css({top:a,left:left})},moveTooltip:function(a,b,c){var d=0,left=0,containerHeight=this.$container.outerHeight(true),containerWidth=this.$container.outerWidth(true),offset=this.settings.tooltip.positionSource.offset(),triggerHeight=this.settings.tooltip.positionSource.outerHeight(),triggerWidth=this.settings.tooltip.positionSource.outerWidth(),distance=this.settings.tooltip.distance,arrowSize=this.settings.tooltip.arrowSize,arrowDistance=this.settings.tooltip.arrowDistance;a=a||this.settings.tooltip.position.split(' ')[0];b=b||this.settings.tooltip.position.split(' ')[1];c=c||0;if(arrowSize){if(!this.$tooltipArrow)this.createElements();this.$tooltipArrow.show();if(/top|bottom/.test(a)){this.$tooltipArrow.css({height:arrowSize,top:a=='top'?'auto':-arrowSize,width:arrowSize*2}).find('div').css({borderLeftColor:'transparent',borderRightColor:'transparent',borderBottomWidth:a=='top'?0:arrowSize,borderTopWidth:a=='bottom'?0:arrowSize}).filter('.mgExternal-arrow-front').css({left:0,top:(a=='top'?'-':'')+this.$data.css('borderBottomWidth')})}else{this.$tooltipArrow.css({height:arrowSize*2,left:a=='left'?'auto':-arrowSize,right:a=='right'?'auto':-arrowSize,width:arrowSize}).find('div').css({borderBottomColor:'transparent',borderTopColor:'transparent',borderLeftWidth:a=='right'?0:arrowSize,borderRightWidth:a=='left'?0:arrowSize}).filter('.mgExternal-arrow-front').css({left:(a=='left'?'-':'')+this.$data.css('borderBottomWidth'),top:0})}}else if(this.$tooltipArrow){this.$tooltipArrow.hide()}switch(a){case'top':d=offset.top-containerHeight-distance-arrowSize;break;case'bottom':d=offset.top+triggerHeight+distance+arrowSize;break;case'left':left=offset.left-containerWidth-distance-arrowSize;break;case'right':left=offset.left+triggerWidth+distance+arrowSize;break}switch(b){case'left':if(this.settings.tooltip.positionFrom=='limit'){left=offset.left}else{left=offset.left+(triggerWidth/2)-arrowDistance-arrowSize}this.$tooltipArrow&&this.$tooltipArrow.css({left:(arrowDistance+arrowSize+15)>containerWidth?(containerWidth/2-arrowSize):arrowDistance,right:'auto'});break;case'center':left=offset.left+(triggerWidth/2)-(containerWidth/2);this.$tooltipArrow&&this.$tooltipArrow.css({left:(containerWidth/2)-arrowSize,right:'auto'});break;case'right':if(this.settings.tooltip.positionFrom=='limit'){left=offset.left+triggerWidth-containerWidth}else{left=offset.left+(triggerWidth/2)-containerWidth+arrowDistance+arrowSize}this.$tooltipArrow&&this.$tooltipArrow.css({left:'auto',right:(arrowDistance+arrowSize+15)>containerWidth?(containerWidth/2-arrowSize):arrowDistance});break;case'top':if(this.settings.tooltip.positionFrom=='limit'){d=offset.top}else{d=offset.top+(triggerHeight/2)-arrowDistance-arrowSize}this.$tooltipArrow&&this.$tooltipArrow.css({bottom:'auto',top:(arrowDistance+arrowSize+15)>containerHeight?(containerHeight/2-arrowSize):arrowDistance});break;case'middle':d=offset.top+(triggerHeight/2)-(containerHeight/2);this.$tooltipArrow&&this.$tooltipArrow.css({bottom:'auto',top:(containerHeight/2)-arrowSize});break;case'bottom':if(this.settings.tooltip.positionFrom=='limit'){d=offset.top+triggerHeight-containerHeight}else{d=offset.top+(triggerHeight/2)-containerHeight+arrowDistance+arrowSize}this.$tooltipArrow&&this.$tooltipArrow.css({bottom:(arrowDistance+arrowSize+15)>containerHeight?(containerHeight/2-arrowSize):arrowDistance,top:'auto'});break}if(this.settings.tooltip.fitWindow&&c<10){if(left<0){if(a=='left')return this.moveTooltip('right',b,c+1);if(b=='right')return this.moveTooltip(a,'center',c+1);if(b=='center')return this.moveTooltip(a,'left',c+1)}if((left+containerWidth+5)>=$(window).width()){if(a=='right')return this.moveTooltip('left',b,c+1);if(b=='left')return this.moveTooltip(a,'center',c+1);if(b=='center')return this.moveTooltip(a,'right',c+1)}if(d<($(document).scrollTop()-5)){if(a=='top')return this.moveTooltip('bottom',b,c+1);if(b=='bottom')return this.moveTooltip(a,'middle',c+1);if(b=='middle')return this.moveTooltip(a,'top',c+1)}if((d+containerHeight+5)>=($(window).height()+$(document).scrollTop())){if(a=='bottom')return this.moveTooltip('top',b,c+1);if(b=='top')return this.moveTooltip(a,'middle',c+1);if(b=='middle')return this.moveTooltip(a,'bottom',c+1)}}this.$container.css({top:d,left:left})}}})(jQuery);