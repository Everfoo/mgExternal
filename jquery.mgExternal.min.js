/**
 * mgExternal 1.0.11
 * www.magicalglobe.com/projects/mgExternal
 *
 * Copyright 2011 Ricard Osorio Mañanas
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */
(function($){$.fn.mgExternal=function(a,b){return this.each(function(){$(this).data('mgExternal',mgExternal(this,a,b))})};window.mgExternal=function(b,c,d){if(!(this instanceof mgExternal))return new mgExternal(b,c,d);if(b.tagName==undefined){d=c;c=b;b=null}if(typeof c=='object'){d=c;c=null}this.settings={display:'modal',content:(d&&d.display=='inline')?$(b):$('<div/>'),auto:!b,renew:(d&&d.tooltip&&d.tooltip.bind=='hover')?false:true,autoFocus:true,outsideClose:true,escClose:true,destroyOnClose:!b,dataCss:{},extraClass:(d&&d.display)?(d.display!='inline'?d.display:null):'modal',showDelay:(d&&d.display=='tooltip'&&d.tooltip&&d.tooltip.bind=='hover')?200:0,hideDelay:(d&&d.display=='tooltip'&&d.tooltip&&d.tooltip.bind=='hover')?200:0,showSpeed:300,hideSpeed:300,overlayColor:'#fff',overlayOpacity:(!d||!d.display||d.display=='modal')?0.7:0,submitIdentifier:'input[type="submit"]',focusPriority:[':not(:radio):input:visible:enabled:first'],ajaxUrl:null,ajaxData:{},tooltip:{bind:'click',position:'top center',positionFrom:(d&&d.tooltip&&d.tooltip.arrowSize==0)?'limit':'center',positionSource:$(b),distance:0,arrowSize:9,arrowDistance:15,arrowFrontColor:null,arrowBorderColor:null,fitWindow:true,activeClass:'active'},onCreateElements:function(){},onBeforeShow:function(){},onShow:function(){},onBeforeClose:function(){},onClose:function(){},onDestroy:function(){},onContentReady:function(){},onJsonData:function(a){}};$.extend(true,this.settings,this.defaults,d,$(b).data('mgExternal'));this.$trigger=$(b);this.$container=null;this.$data=null;this.$content=this.settings.content;this.$tooltipArrow=null;this._defaultContent=c;this._defaultAjaxUrl=this.settings.ajaxUrl;this._lastSubmitName=null;this._show=false;this._triggerZIndexBackup=null;if(this.$trigger){var f=this;switch(this.settings.display){case'modal':this.$trigger.bind('click',function(e){f.open(f.settings.showDelay);e.preventDefault();e.stopPropagation()});break;case'tooltip':switch(this.settings.tooltip.bind){case'click':this.$trigger.bind('click',function(e){f.isVisible()?f.close():f.open(f.settings.showDelay);e.preventDefault();e.stopPropagation()});break;case'hover':this.$trigger.bind({mouseenter:function(){f.open(f.settings.showDelay)},mouseleave:function(){f.close(f.settings.hideDelay)},mouseup:function(e){e.stopPropagation()}});break;case'focus':this.$trigger.bind({focus:function(){f.open(f.settings.showDelay)},blur:function(){f.close(f.settings.hideDelay)},mouseup:function(e){e.stopPropagation()}});break}break;case'inline':this.bindSpecialActions();break}}if(this.settings.auto)this.open()};mgExternal.prototype={defaults:{},isVisible:function(){return this.$container&&this.$container.is(':visible')&&this.$container.css('visibility')!='hidden'},open:function(a){var b=this;this._show=true;setTimeout(function(){b.realOpen()},a||10)},realOpen:function(){if(!this._show)return;if(this.settings.renew||!this.$container){this.settings.ajaxUrl=this._defaultAjaxUrl;this._lastSubmitName=null;if(this._defaultContent){this.setContent(this._defaultContent)}else{this.loadAjaxContent()}}else{this.showContainer()}},close:function(a){var b=this;this._show=false;setTimeout(function(){b.realClose()},a||10)},realClose:function(){if(this._show||!this.isVisible()||this.settings.onBeforeClose.call(this)===false)return;var a=this;if(this.settings.display=='tooltip'){this.$trigger.removeClass(this.settings.tooltip.activeClass).css({position:this._triggerZIndexBackup.position,zIndex:this._triggerZIndexBackup.zIndex})}this.$container.fadeOut(this.settings.hideSpeed,function(){if(a.settings.destroyOnClose)a.destroy();if(a.settings.overlayOpacity>0&&a.settings.display=='modal'){$('#mgExternal-overlay').fadeOut(a.settings.hideSpeed,function(){a.settings.onClose.call(a)})}else{a.settings.onClose.call(a)}});if(this.settings.overlayOpacity>0&&this.settings.display!='modal')$('#mgExternal-overlay').fadeOut(this.settings.hideSpeed)},setContent:function(a){var b=this;if(!this.$container)this.createElements();this.$content.html(a).children().css({marginLeft:0,marginRight:0}).first().css('margin-top','0').end().last().css('margin-bottom','0');if(!this.isVisible())this.$container.css('visibility','hidden').show();this.bindSpecialActions();this.settings.onContentReady.call(this);this.setFocus();if(this.settings.display!='inline'){if(this.isVisible()){this.moveContainer()}else{this.$container.hide().css('visibility','visible');this.showContainer()}}},showContainer:function(){if(this.settings.onBeforeShow.call(this)===false)return;var a=this;if(this.settings.display=='tooltip'){this._triggerZIndexBackup={position:this.$trigger.css('position'),zIndex:this.$trigger.css('z-index')};this.$trigger.addClass(this.settings.tooltip.activeClass).css({position:this._triggerZIndexBackup.position=='static'?'relative':null,zIndex:998})}var b=function(){a.$container.fadeIn(a.settings.showSpeed,function(){a.settings.onShow.call(a);a.setFocus()})};if(this.settings.overlayOpacity>0){$('#mgExternal-overlay').css({background:this.settings.overlayColor,opacity:this.settings.overlayOpacity});if(this.settings.display=='modal'){$('#mgExternal-overlay').fadeIn(this.settings.showSpeed,b)}else{$('#mgExternal-overlay').fadeIn(this.settings.showSpeed);b()}}else{b()}this.moveContainer();this.$container.find('img').bind('load',function(){a.moveContainer()})},destroy:function(){this.$container.remove();this.settings.onDestroy.call(this)},bindSpecialActions:function(){var a=this;this.$content.find('form').bind('submit',function(e){a.loadAjaxContent($(this));e.preventDefault()});this.$content.find('.mgExternal-redirect').bind('click',function(e){a.settings.ajaxUrl=$(this).attr('href');a.loadAjaxContent();e.preventDefault()});this.$content.find('.mgExternal-close').bind('click',function(e){a.close();e.preventDefault()})},loadAjaxContent:function(d){var e=this,ajaxData=$.extend({},e.settings.ajaxData);if(d){this._lastSubmitName=d.find(this.settings.submitIdentifier).val();d.find(':input').each(function(){if($(this).is(':checkbox')){ajaxData[$(this).attr('name')]=$(this).prop('checked')?1:0}else if($(this).is(':radio')){if($(this).prop('checked'))ajaxData[$(this).attr('name')]=$(this).val()}else{ajaxData[$(this).attr('name')]=$(this).val()}})}if(d&&d.attr('enctype')=='multipart/form-data'){alert("multipart form")}else{$.ajax({url:this.settings.ajaxUrl||this.$trigger.attr('href'),type:d?'POST':'GET',data:ajaxData,success:function(a){if(typeof a=='object'){e.settings.onJsonData.call(e,a)}else{e.setContent(a)}},error:function(a,b,c){e.setContent("<div class=\"notice alert\">S'ha produït un error</div>")}})}this.$content.find(':input').prop('disabled',true).addClass('disabled')},setFocus:function(){if(!this.settings.autoFocus)return;var a=this.$content.find(this.settings.submitIdentifier+'[value="'+this._lastSubmitName+'"]').parents('form:visible');if(a.length==0)a=this.$content.find('form:first:visible');if(a.length==0)a=this.$content;for(var i=0,firstInput=a.find(this.settings.focusPriority[i]);firstInput.length==0&&i<=this.settings.focusPriority.length;firstInput=a.find(this.settings.focusPriority[++i]));setTimeout(function(){firstInput.trigger('focus')},10)},createElements:function(){var a=this;if(!this.$container){this.$container=$('<div/>').addClass('mgExternal-container').addClass(this.settings.extraClass).css({position:'absolute',zIndex:999}).hide().appendTo('body').bind('mouseup',function(e){e.stopPropagation()});this.$data=$('<div/>').addClass('mgExternal-data').css(this.settings.dataCss).appendTo(this.$container).append(this.$content);if(this.settings.tooltip.bind=='hover'){this.$container.bind('mouseenter',function(){a.open(a.settings.showDelay)});this.$container.bind('mouseleave',function(){a.close(a.settings.hideDelay)})}if(this.settings.display!='inline'){$(window).bind('resize',function(){a.moveContainer()});if(this.settings.outsideClose){$('body').bind('mouseup',function(e){if(e.which==1)a.close()})}if(this.settings.escClose){$(document).bind('keyup',function(e){if(e.keyCode==27)a.close()})}}a.settings.onCreateElements.call(a)}if(this.settings.overlayOpacity>0&&$('#mgExternal-overlay').length==0){this.$modalOverlay=$('<div/>').attr('id','mgExternal-overlay').css({height:$('body').height(),left:0,position:'fixed',top:0,width:$('body').width(),zIndex:997}).hide().appendTo('body')}if(!this.$tooltipArrow&&this.settings.display=='tooltip'&&this.settings.tooltip.arrowSize){this.$tooltipArrow=$('<div/>').addClass('mgExternal-arrow').css({position:'absolute'}).appendTo(this.$container).append($('<div/>').addClass('mgExternal-arrow-shadow').css({borderColor:this.settings.tooltip.arrowBorderColor,borderStyle:'solid',borderWidth:this.settings.tooltip.arrowSize})).append($('<div/>').addClass('mgExternal-arrow-front').css({borderColor:this.settings.tooltip.arrowFrontColor||this.$data.css('backgroundColor'),borderStyle:'solid',position:'absolute',borderWidth:this.settings.tooltip.arrowSize}))}},moveContainer:function(){switch(this.settings.display){case'modal':this.moveModal();break;case'tooltip':this.moveTooltip();break}},moveModal:function(){var a=0,left=0,containerHeight=this.$container.outerHeight(true),containerWidth=this.$container.outerWidth(true);if(containerHeight<$(window).height())a=$(document).scrollTop()+(($(window).height()-containerHeight)/2)-15;if(a<($(document).scrollTop()+15))a=$(document).scrollTop()+15;left=($(window).width()-containerWidth)/2;if(left<15)left=15;this.$container.css({top:a,left:left})},moveTooltip:function(a,b,c){var d=0,left=0,containerHeight=this.$container.outerHeight(true),containerWidth=this.$container.outerWidth(true),sourceOffset=this.settings.tooltip.positionSource.offset(),sourceHeight=this.settings.tooltip.positionSource.outerHeight(),sourceWidth=this.settings.tooltip.positionSource.outerWidth(),distance=this.settings.tooltip.distance,arrowSize=this.settings.tooltip.arrowSize,arrowDistance=this.settings.tooltip.arrowDistance;a=a||this.settings.tooltip.position.split(' ')[0];b=b||this.settings.tooltip.position.split(' ')[1];c=c||0;if(arrowSize){if(!this.$tooltipArrow)this.createElements();this.$tooltipArrow.show();if(/top|bottom/.test(a)){this.$tooltipArrow.css({height:arrowSize,top:a=='top'?'auto':-arrowSize,width:arrowSize*2}).find('div').css({borderLeftColor:'transparent',borderRightColor:'transparent',borderBottomWidth:a=='top'?0:arrowSize,borderTopWidth:a=='bottom'?0:arrowSize}).filter('.mgExternal-arrow-front').css({left:0,top:(a=='top'?'-':'')+this.$data.css('borderBottomWidth')})}else{this.$tooltipArrow.css({height:arrowSize*2,left:a=='left'?'auto':-arrowSize,right:a=='right'?'auto':-arrowSize,width:arrowSize}).find('div').css({borderBottomColor:'transparent',borderTopColor:'transparent',borderLeftWidth:a=='right'?0:arrowSize,borderRightWidth:a=='left'?0:arrowSize}).filter('.mgExternal-arrow-front').css({left:(a=='left'?'-':'')+this.$data.css('borderBottomWidth'),top:0})}}else if(this.$tooltipArrow){this.$tooltipArrow.hide()}switch(a){case'top':d=sourceOffset.top-containerHeight-distance-arrowSize;break;case'bottom':d=sourceOffset.top+sourceHeight+distance+arrowSize;break;case'left':left=sourceOffset.left-containerWidth-distance-arrowSize;break;case'right':left=sourceOffset.left+sourceWidth+distance+arrowSize;break}switch(b){case'left':if(this.settings.tooltip.positionFrom=='limit'){left=sourceOffset.left}else{left=sourceOffset.left+(sourceWidth/2)-arrowDistance-arrowSize}if(this.$tooltipArrow){if(this.settings.tooltip.positionFrom=='limit'&&!arrowDistance){this.$tooltipArrow.css({left:(sourceWidth/2)-arrowSize,right:'auto'})}else{this.$tooltipArrow.css({left:arrowDistance,right:'auto'})}}break;case'center':left=sourceOffset.left+(sourceWidth/2)-(containerWidth/2);this.$tooltipArrow&&this.$tooltipArrow.css({left:(containerWidth/2)-arrowSize,right:'auto'});break;case'right':if(this.settings.tooltip.positionFrom=='limit'){left=sourceOffset.left+sourceWidth-containerWidth}else{left=sourceOffset.left+(sourceWidth/2)-containerWidth+arrowDistance+arrowSize}if(this.$tooltipArrow){if(this.settings.tooltip.positionFrom=='limit'&&!arrowDistance){this.$tooltipArrow.css({left:'auto',right:(sourceWidth/2)-arrowSize})}else{this.$tooltipArrow.css({left:'auto',right:arrowDistance})}}break;case'top':if(this.settings.tooltip.positionFrom=='limit'){d=sourceOffset.top}else{d=sourceOffset.top+(sourceHeight/2)-arrowDistance-arrowSize}if(this.$tooltipArrow){if(this.settings.tooltip.positionFrom=='limit'&&!arrowDistance){this.$tooltipArrow.css({bottom:'auto',top:(sourceHeight/2)-arrowSize})}else{this.$tooltipArrow.css({bottom:'auto',top:arrowDistance})}}break;case'middle':d=sourceOffset.top+(sourceHeight/2)-(containerHeight/2);this.$tooltipArrow&&this.$tooltipArrow.css({bottom:'auto',top:(containerHeight/2)-arrowSize});break;case'bottom':if(this.settings.tooltip.positionFrom=='limit'){d=sourceOffset.top+sourceHeight-containerHeight}else{d=sourceOffset.top+(sourceHeight/2)-containerHeight+arrowDistance+arrowSize}if(this.$tooltipArrow){if(this.settings.tooltip.positionFrom=='limit'&&!arrowDistance){this.$tooltipArrow.css({bottom:(sourceHeight/2)-arrowSize,top:'auto'})}else{this.$tooltipArrow.css({bottom:arrowDistance,top:'auto'})}}break}if(this.settings.tooltip.fitWindow&&c<10){if(left<0){if(a=='left')return this.moveTooltip('right',b,c+1);if(b=='right')return this.moveTooltip(a,'center',c+1);if(b=='center')return this.moveTooltip(a,'left',c+1)}if((left+containerWidth+5)>=$(window).width()){if(a=='right')return this.moveTooltip('left',b,c+1);if(b=='left')return this.moveTooltip(a,'center',c+1);if(b=='center')return this.moveTooltip(a,'right',c+1)}if(d<($(document).scrollTop()-5)){if(a=='top')return this.moveTooltip('bottom',b,c+1);if(b=='bottom')return this.moveTooltip(a,'middle',c+1);if(b=='middle')return this.moveTooltip(a,'top',c+1)}if((d+containerHeight+5)>=($(window).height()+$(document).scrollTop())){if(a=='bottom')return this.moveTooltip('top',b,c+1);if(b=='top')return this.moveTooltip(a,'middle',c+1);if(b=='middle')return this.moveTooltip(a,'bottom',c+1)}}this.$container.css({top:d,left:left})}}})(jQuery);